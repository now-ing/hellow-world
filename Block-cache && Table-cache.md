



1.  å‚è€ƒï¼š https://www.cnblogs.com/haippy/archive/2011/12/04/2276064.html  ï¼ˆå¥½çš„åšå®¢ã€‚ï¼‰







# ä¸€äº›è­¦ç¤ºï¼š

## ï¼ˆ1ï¼‰ æ˜æ˜é‚£ä¸ªåˆ«äººçš„ç½‘ä¸Šçš„åšå®¢è¯´leveldbè¿™ä¸ªä¸œè¥¿çœ‹1 weekå°±å¯ä»¥éå¸¸æ‡‚äº†ã€‚è‡ªå·±å±…ç„¶èŠ±è´¹äº†é‚£ä¹ˆå¤šçš„æ—¶é—´ï¼Œè¿™å’Œè‡ªå·±æ€»æ˜¯æƒ³ä¸€äº›æ²¡ç”¨çš„ä¸œè¥¿ä»¥åŠè‡ªå·±æ€»æ˜¯å»å…³æ³¨å„ç§æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰çš„æ—¶äº‹æ–°é—»æœ‰å…³ã€‚ã€‚è‡ªå·±æ²¡æœ‰éå¸¸å¥½åœ°çæƒœè‡ªå·±çš„æ—¶é—´ğŸšªã€‘ã€‚ï¼ˆå…¶å®å› ä¸ºè‡ªå·±åªè¦ï¼‰ ==(è‡ªå·±å¯èƒ½éœ€è¦éå¸¸æ¿€åŠ¨åœ°çœ‹ä»£ç   ä»¥åŠæ—¶åˆ»æƒ³ç€è‡ªå·±æ­£åœ¨é¢ä¸´çš„å‹åŠ›äº†ã€‚==       

==:123==: 

==é«˜äº® æ˜¾ç¤º==ï¼š== +å­—ä½“ +==



## ï¼ˆ2ï¼‰ï¼šè‡ªå·±åœ¨å‰æœŸçœ‹å¸¦ä»£ç çš„æ—¶å€™æ˜æ˜¾æ„Ÿè§‰åˆ°è‡ªå·±èµ°äº†å¾ˆå¤šçš„å¼¯è·¯ï¼Œæ¯”å¦‚ç›´æ¥çœ‹ä»£ç çš„æ—¶å€™æ²¡æœ‰æ³¨æ„é‡Œé¢çš„release å’Œeraseå¯¹äºlru çš„ä½¿ç”¨ï¼Œä»¥åŠè‡ªå·±æ²¡æœ‰ä»é¡¶å±‚å»æ³¨æ„é‚£äº›ä¸œè¥¿ã€‚ è¿˜æœ‰å°±æ˜¯è‡ªå·±é…ç½®docker  é“¾æ¥clion éƒ½å¼„äº†é‚£ä¹ˆä¹…ã€‚è€Œçœ‹äº†é‚£ä¹ˆå¤šçš„ä¸œè¥¿è‡ªå·±ä¹Ÿæ²¡æœ‰æ€æ ·åŠ¨æ‰‹ã€‚

















#  ç–‘é—®ï¼š

## 1.



# ç¬”è®°è¦ç‚¹ï¼š

## 1.  C++ä¸­æ„é€ å‡½æ•°æˆ–ææ„å‡½æ•°å®šä¹‰ä¸ºprivate

å‚è€ƒï¼š https://blog.csdn.net/vivian187/article/details/93043070 







``` C++


class LEVELDB_EXPORT Table {
 private:
  friend class TableCache;
  //TODO??  åº”è¯¥æ€ä¹ˆå»ç†è§£è¿™ç§æ²¡æœ‰åœ¨ç±»å†…å®šä¹‰çš„structï¼Ÿ
  struct Rep;

  static Iterator* BlockReader(void*, const ReadOptions&, const Slice&);

  //TODO??? ä¸ºä»€ä¹ˆå¤–é¢å½“å¯ä»¥è°ƒç”¨ new Table ï¼Ÿ è¿™ä¸ªåœ°æ–¹ä¸æ˜¯è¯´privateé‡Œé¢çš„å‡½æ•°å—ï¼Ÿ
  explicit Table(Rep* rep) : rep_(rep) {}

}
Status Table::Open(const Options& options, RandomAccessFile* file,
                   uint64_t size, Table** table) {

		*table = new Table(rep);//è¿™ä¸ªTableçš„æ„é€ å‡½æ•° æ˜¯private çš„ï¼Œä½†æ˜¯åªè¦ä¸æ˜¯å®ä¾‹åŒ–å°±å¯ä»¥è°ƒç”¨ï¼Œå¹¶ä¸”è¿”å›ä¸€ä¸ªæŒ‡é’ˆ*
    (*table)->ReadMeta(footer);
}
```





## 2 ã€‚å‚è€ƒï¼šhttps://www.cnblogs.com/liuhao/archive/2012/11/29/2795455.html 

   [LevelDB](http://code.google.com/p/leveldb/)æ˜¯Googleå¼€æºçš„æŒä¹…åŒ–KVå•æœºå­˜å‚¨å¼•æ“ï¼Œæ®ç§°æ˜¯HBaseçš„é¼»ç¥–[Bigtable](http://wenku.baidu.com/view/176e3f0d4a7302768e99399c.html)çš„é‡è¦ç»„ä»¶tabletçš„å¼€æºå®ç°ã€‚é’ˆå¯¹å­˜å‚¨é¢å¯¹çš„æ™®ééšæœºIOé—®é¢˜ï¼ŒLevelDBé‡‡ç”¨merge-dumpçš„æ–¹å¼ï¼Œå°†é€»è¾‘åœºæ™¯çš„éšæœºå†™è¯·æ±‚è½¬æ¢æˆé¡ºåºå†™logå’Œå†™memtableçš„æ“ä½œï¼Œç”±åå°çº¿ç¨‹æ ¹æ®ç­–ç•¥å°†memtableæŒä¹…åŒ–æˆåˆ†å±‚çš„sstableã€‚é’ˆå¯¹è¯»è¯·æ±‚ï¼ŒLevelDBä¼šé¦–å…ˆæŸ¥æ‰¾å†…å­˜ä¸­çš„memtableå’Œimmï¼ˆä¸å¯å˜çš„memtableï¼‰ï¼Œç„¶åé€å±‚æŸ¥æ‰¾sstableã€‚

   ä¸ºäº†åŠ å¿«æŸ¥æ‰¾é€Ÿåº¦ï¼ŒLevelDBåœ¨å†…å­˜ä¸­é‡‡ç”¨Cacheçš„æ–¹å¼ï¼Œåœ¨sstableä¸­é‡‡ç”¨bloom filterçš„æ–¹å¼ï¼Œå°½æœ€å¤§å¯èƒ½å‡å°‘éšæœºè¯»æ“ä½œã€‚

 



   LevelDBçš„Cacheåˆ†ä¸ºä¸¤ç§ï¼Œåˆ†åˆ«æ˜¯table cacheå’Œblock cacheã€‚table cacheç¼“å­˜çš„æ˜¯sstableçš„ç´¢å¼•æ•°æ®ï¼Œç±»ä¼¼äºæ–‡ä»¶ç³»ç»Ÿä¸­å¯¹inodeçš„ç¼“å­˜ï¼›block cacheæ˜¯ç¼“å­˜çš„blockæ•°æ®ï¼Œblockæ˜¯sstableæ–‡ä»¶å†…ç»„ç»‡æ•°æ®çš„å•ä½ï¼Œä¹Ÿæ˜¯ä»æŒä¹…åŒ–å­˜å‚¨ä¸­è¯»å–å’Œå†™å…¥çš„å•ä½ï¼›ç”±äºsstableæ˜¯æŒ‰ç…§keyæœ‰åºåˆ†å¸ƒçš„ï¼Œå› æ­¤ä¸€ä¸ªblockå†…çš„æ•°æ®ä¹Ÿæ˜¯æŒ‰ç…§keyç´§é‚»æ’å¸ƒçš„ï¼ˆæœ‰åºä¾ç…§ä½¿ç”¨è€…ä¼ å…¥çš„æ¯”è¾ƒå‡½æ•°ï¼Œé»˜è®¤æŒ‰ç…§å­—å…¸åºï¼‰ï¼Œç±»ä¼¼äºLinuxä¸­çš„page cache







 table cacheé»˜è®¤å¤§å°æ˜¯1000ï¼Œæ³¨æ„æ­¤å¤„ç¼“å­˜çš„æ˜¯1000ä¸ªsstableæ–‡ä»¶çš„ç´¢å¼•ä¿¡æ¯ï¼Œè€Œä¸æ˜¯1000ä¸ªå­—èŠ‚ã€‚table cacheçš„å¤§å°ç”±options.max_open_filesç¡®å®šï¼Œå…¶æœ€å°å€¼ä¸º20-10ï¼Œæœ€å¤§å€¼ä¸º50000ï¼10ã€‚

 







   1) é¦–å…ˆä»block cacheä¸­æŸ¥æ‰¾blockï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼Œç›´æ¥ä»æŒä¹…åŒ–å­˜å‚¨ä¸­è¯»å–ï¼Œè·å–åˆ°ä¸€ä¸ªæ–°çš„blockï¼Œæ’å…¥block cache;

   2) å¯¹äºæŸ¥åˆ°çš„blockï¼Œè¿”å›å¯¹åº”çš„è¿­ä»£å™¨ï¼ˆLevelDBä¸­ï¼Œæ‰€æœ‰çš„get\mergeæ“ä½œå‡æ˜¯æŠ½è±¡æˆiteratorå®ç°çš„ï¼‰ï¼›

   3ï¼‰å¦‚æœä»”ç»†è¯»ä»£ç ï¼Œiter->RegisterCleanupå‡½æ•°å®ç°ä¼šæœ‰ç‚¹ç»•ï¼Œè¿™ä¸ªå‡½æ•°åœ¨iterææ„æ—¶è¢«è°ƒç”¨ï¼Œæ‰§è¡Œæ³¨å†Œçš„ReleaseBlockï¼ŒReleaseBlockè°ƒç”¨cache_handleçš„Unrefæ–¹æ³•ï¼Œå¯¹cacheä¸­ç¼“å­˜çš„blockå‡å°‘ä¸€ä¸ªå¼•ç”¨è®¡æ•°ï¼›cacheæ‰§è¡Œinsertå‡½æ•°æ—¶ï¼Œä¼šç»™æ‰€æœ‰çš„LRUHandleçš„å¼•ç”¨è®¡æ•°è®¾æˆ2ï¼Œå…¶ä¸­1ç”¨äºLRUCacheè‡ªèº«ï¼Œåœ¨æ‰§è¡Œcacheçš„Releaseæ“ä½œæ—¶è¢«Unrefï¼Œä»è€ŒçœŸæ­£é‡Šæ”¾ã€‚











## ä¸‰ã€Table Cache  

åŸºäºLRUCacheå®ç°ã€‚key-valueå¦‚ä¸‹ï¼š

![img](https://pic1.zhimg.com/80/v2-a15e0f8d4de042656d1814f0b997fddc_1440w.jpg)

## ** LevelDbæ—¥çŸ¥å½•ä¹‹ä¹** **levelDbä¸­çš„****Cache**

ã€€ã€€ä¹¦æ¥å‰æ–‡ï¼Œå‰é¢è®²è¿‡å¯¹äºlevelDbæ¥è¯´ï¼Œè¯»å–æ“ä½œå¦‚æœæ²¡æœ‰åœ¨å†…å­˜çš„memtableä¸­æ‰¾åˆ°è®°å½•ï¼Œè¦å¤šæ¬¡è¿›è¡Œç£ç›˜è®¿é—®æ“ä½œã€‚å‡è®¾æœ€ä¼˜æƒ…å†µï¼Œå³ç¬¬ä¸€æ¬¡å°±åœ¨level 0ä¸­æœ€æ–°çš„æ–‡ä»¶ä¸­æ‰¾åˆ°äº†è¿™ä¸ªkeyï¼Œé‚£ä¹ˆä¹Ÿéœ€è¦è¯»å–2æ¬¡ç£ç›˜ï¼Œä¸€æ¬¡æ˜¯å°†SSTableçš„æ–‡ä»¶ä¸­çš„indexéƒ¨åˆ†è¯»å…¥å†…å­˜ï¼Œè¿™æ ·æ ¹æ®è¿™ä¸ªindexå¯ä»¥ç¡®å®škeyæ˜¯åœ¨å“ªä¸ªblockä¸­å­˜å‚¨ï¼›ç¬¬äºŒæ¬¡æ˜¯è¯»å…¥è¿™ä¸ªblockçš„å†…å®¹ï¼Œç„¶ååœ¨å†…å­˜ä¸­æŸ¥æ‰¾keyå¯¹åº”çš„valueã€‚

ã€€ã€€levelDbä¸­å¼•å…¥äº†ä¸¤ä¸ªä¸åŒçš„Cache:Table Cacheå’ŒBlock Cacheã€‚å…¶ä¸­Block Cacheæ˜¯é…ç½®å¯é€‰çš„ï¼Œå³åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šæ˜¯å¦æ‰“å¼€è¿™ä¸ªåŠŸèƒ½ã€‚

![img](Block-cache%20&&%20Table-cache.assets/2011121116391556.png)

å›¾9.1 table cache

 ã€€å›¾9.1æ˜¯table cacheçš„ç»“æ„ã€‚åœ¨Cacheä¸­ï¼Œkeyå€¼æ˜¯SSTableçš„æ–‡ä»¶åç§°ï¼ŒValueéƒ¨åˆ†åŒ…å«ä¸¤éƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯æŒ‡å‘ç£ç›˜æ‰“å¼€çš„SSTableæ–‡ä»¶çš„æ–‡ä»¶æŒ‡é’ˆï¼Œè¿™æ˜¯ä¸ºäº†æ–¹ä¾¿è¯»å–å†…å®¹ï¼›å¦å¤–ä¸€ä¸ªæ˜¯æŒ‡å‘å†…å­˜ä¸­è¿™ä¸ªSSTableæ–‡ä»¶å¯¹åº”çš„Tableç»“æ„æŒ‡é’ˆï¼Œtableç»“æ„åœ¨å†…å­˜ä¸­ï¼Œä¿å­˜äº†SSTableçš„indexå†…å®¹ä»¥åŠç”¨æ¥æŒ‡ç¤ºblock cacheç”¨çš„cache_id ,å½“ç„¶é™¤æ­¤å¤–è¿˜æœ‰å…¶å®ƒä¸€äº›å†…å®¹ã€‚

 

- keyå€¼æ˜¯SSTableçš„æ–‡ä»¶åç§°

- Valueéƒ¨åˆ†åŒ…å«ä¸¤éƒ¨åˆ†

- - RandomAccessFile*: æŒ‡å‘ç£ç›˜æ‰“å¼€çš„SSTableæ–‡ä»¶çš„æ–‡ä»¶æŒ‡é’ˆã€‚
  - Table*: æ˜¯æŒ‡å‘å†…å­˜ä¸­è¿™ä¸ªSSTableæ–‡ä»¶å¯¹åº”çš„Tableç»“æ„æŒ‡é’ˆï¼Œtableç»“æ„åœ¨å†…å­˜ä¸­ï¼Œä¿å­˜äº†SSTableçš„indexå†…å®¹ä»¥åŠç”¨æ¥æŒ‡ç¤ºblock cacheç”¨çš„cache_idã€‚

- 

```C++
ä»è¿™ä¸ªå¯ä»¥çœ‹å‡ºæ¥å»é™¤ä¸€
void TableCache::Evict(uint64_t file_number) {
  char buf[sizeof(file_number)];
  EncodeFixed64(buf, file_number);
  cache_->Erase(Slice(buf, sizeof(buf)));
}
```



## å››ã€Block Cache

![img](https://pic4.zhimg.com/80/v2-7735891ae5754f6e7efb2e1e0ea2355b_1440w.jpg)

ç»“æ„å¦‚ä¸‹ï¼š

- keyï¼šæ–‡ä»¶çš„cache_id + è¿™ä¸ªblockåœ¨æ–‡ä»¶ä¸­çš„offsetã€‚
- valueï¼šBlockçš„å†…å®¹ã€‚

